<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Wasserstein Median of Images — imagemed • T4transport</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Wasserstein Median of Images — imagemed"><meta name="description" content="Using exact balanced optimal transport as a subroutine, imagemed
computes an unregularized 2-Wasserstein geometric median image \(X^\dagger\)
from multiple input images \(X_1,\ldots,X_N\). The Wasserstein median is
defined as a minimizer of the (weighted) sum of Wasserstein distances,
$$ \arg\min_{X} \sum_{i=1}^N w_i\, W_2(X, X_i). $$"><meta property="og:description" content="Using exact balanced optimal transport as a subroutine, imagemed
computes an unregularized 2-Wasserstein geometric median image \(X^\dagger\)
from multiple input images \(X_1,\ldots,X_N\). The Wasserstein median is
defined as a minimizer of the (weighted) sum of Wasserstein distances,
$$ \arg\min_{X} \sum_{i=1}^N w_i\, W_2(X, X_i). $$"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">T4transport</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><h6 class="dropdown-header" data-toc-skip>Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/basic_compute_distance.html">Computing the Wasserstein distance</a></li>
    <li><hr class="dropdown-divider"></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/kisung_you" aria-label="Twitter/X"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/kisungyou/T4transport" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../mailto:kisung.you@outlook.com" aria-label="Email"><span class="fa fa-envelope"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Wasserstein Median of Images</h1>

      <div class="d-none name"><code>imagemed.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Using exact balanced optimal transport as a subroutine, <code>imagemed</code>
computes an unregularized 2-Wasserstein geometric median image \(X^\dagger\)
from multiple input images \(X_1,\ldots,X_N\). The Wasserstein median is
defined as a minimizer of the (weighted) sum of Wasserstein distances,
$$ \arg\min_{X} \sum_{i=1}^N w_i\, W_2(X, X_i). $$</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">imagemed</span><span class="op">(</span><span class="va">images</span>, weights <span class="op">=</span> <span class="cn">NULL</span>, C <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-images">images<a class="anchor" aria-label="anchor" href="#arg-images"></a></dt>
<dd><p>a length-\(N\) list of same-size grayscale image matrices of size \((m\times n)\).</p></dd>


<dt id="arg-weights">weights<a class="anchor" aria-label="anchor" href="#arg-weights"></a></dt>
<dd><p>a weight of each image; if <code>NULL</code> (default), uniform weight is set.
Otherwise, it should be a length-\(N\) vector of nonnegative weights.</p></dd>


<dt id="arg-c">C<a class="anchor" aria-label="anchor" href="#arg-c"></a></dt>
<dd><p>an optional \((mn\times mn)\) ground cost matrix (squared distances). If <code>NULL</code>
(default), the squared Euclidean grid cost is used.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>extra parameters including</p><dl><dt>maxiter</dt>
<dd><p>maximum number of IRLS outer iterations (default: <code>30</code>).</p></dd>

<dt>abstol</dt>
<dd><p>stopping tolerance based on \(\ell_2\) change of iterates (default: <code>1e-6</code>).</p></dd>

<dt>delta</dt>
<dd><p>small positive number to avoid division by zero in IRLS weights
  (default: <code>1e-8</code>).</p></dd>

<dt>init.image</dt>
<dd><p>initial median iterate (default: unweighted barycenter via <code>imagebary</code>
  with a small number of iterations).</p></dd>

<dt>init.bary.iter</dt>
<dd><p>iterations for the default initialization barycenter (default: <code>10</code>).</p></dd>

<dt>bary.maxiter</dt>
<dd><p>maximum iterations for each barycenter subproblem (default: <code>200</code>).</p></dd>

<dt>bary.abstol</dt>
<dd><p>tolerance for each barycenter subproblem (default: <code>1e-7</code>).</p></dd>

<dt>bary.step0</dt>
<dd><p>initial step size for barycenter subproblem (default: <code>0.5</code>).</p></dd>

<dt>bary.stepschedule</dt>
<dd><p><code>"sqrt"</code> or <code>"const"</code> for barycenter subproblem (default: <code>"sqrt"</code>).</p></dd>

<dt>bary.eps</dt>
<dd><p>positivity floor used inside barycenter (default: <code>1e-15</code>).</p></dd>

<dt>bary.smooth</dt>
<dd><p>smoothing used inside barycenter (default: <code>1e-12</code>).</p></dd>

<dt>bary.clip</dt>
<dd><p>gradient clipping used inside barycenter (default: <code>50</code>).</p></dd>

<dt>bary.max_backtrack</dt>
<dd><p>backtracking cap used inside barycenter (default: <code>8</code>).</p></dd>

<dt>print.progress</dt>
<dd><p>logical; if <code>TRUE</code>, print iteration diagnostics (default: <code>FALSE</code>).</p></dd>


</dl></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>an \((m\times n)\) matrix of the median.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Unlike Wasserstein barycenters (which minimize squared distances), the median
is a robust notion of centrality. This function solves the problem with an
iterative reweighted least squares (IRLS) scheme (a Wasserstein analogue of
Weiszfeld's algorithm). Each outer iteration updates weights based on current
distances and then solves a weighted Wasserstein barycenter problem:
$$ \alpha_i^{(k)} \propto \frac{w_i}{\max(W_2(X^{(k)},X_i),\delta)}, \qquad
       X^{(k+1)} = \arg\min_X \sum_{i=1}^N \alpha_i^{(k)}\, W_2^2(X, X_i). $$</p>
<p>The barycenter subproblem is solved by <code><a href="imagebary.html">imagebary</a></code> (mirror descent
with exact OT dual subgradients). Distances \(W_2\) are computed by exact
EMD plans under the same squared ground cost.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co">#----------------------------------------------------------------------</span></span></span>
<span class="r-in"><span><span class="co">#                             MNIST Example</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># Use 6 images from digit '8' and 4 images from digit '1'.</span></span></span>
<span class="r-in"><span><span class="co"># The median should look closer to the shape of '8'.</span></span></span>
<span class="r-in"><span><span class="co">#----------------------------------------------------------------------</span></span></span>
<span class="r-in"><span><span class="co"># DATA PREP</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">digits</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat_8</span> <span class="op">=</span> <span class="va">digits</span><span class="op">$</span><span class="va">image</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">digits</span><span class="op">$</span><span class="va">label</span><span class="op">==</span><span class="fl">8</span><span class="op">)</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">dat_1</span> <span class="op">=</span> <span class="va">digits</span><span class="op">$</span><span class="va">image</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">digits</span><span class="op">$</span><span class="va">label</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">dat_all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dat_8</span>, <span class="va">dat_1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># COMPUTE BARYCENTER AND MEDIAN</span></span></span>
<span class="r-in"><span><span class="va">img_bary</span> <span class="op">=</span> <span class="fu"><a href="imagebary.html">imagebary</a></span><span class="op">(</span><span class="va">dat_all</span>, maxiter<span class="op">=</span><span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">img_med</span>  <span class="op">=</span> <span class="fu">imagemed</span><span class="op">(</span><span class="va">dat_all</span>, maxiter<span class="op">=</span><span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># VISUALIZE</span></span></span>
<span class="r-in"><span><span class="va">opar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>no.readonly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, pty<span class="op">=</span><span class="st">"s"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">img_bary</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, main<span class="op">=</span><span class="st">"Barycenter"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">img_med</span>,  axes<span class="op">=</span><span class="cn">FALSE</span>, main<span class="op">=</span><span class="st">"Median"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">opar</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kisung You.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

